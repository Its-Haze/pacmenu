#!/usr/bin/env bash
# pacmenu - Interactive TUI for Arch Linux package management
# Main launcher and dispatcher

set -euo pipefail

# ── Resolve shared library ───────────────────────────────────────────
SCRIPT_DIR="$(dirname "$(readlink -f "$0")")"
for _lib in \
    "$SCRIPT_DIR/../lib/pacmenu-core.sh" \
    "$HOME/.local/lib/pacmenu/pacmenu-core.sh" \
    "/usr/lib/pacmenu/pacmenu-core.sh"; do
    # shellcheck source=../lib/pacmenu-core.sh
    [[ -f "$_lib" ]] && { source "$_lib"; break; }
done
[[ -z "${PACMENU_VERSION:-}" ]] && { echo "Error: pacmenu-core.sh not found" >&2; exit 1; }

# ── Functions ────────────────────────────────────────────────────────

show_help() {
    cat <<EOF
pacmenu v${PACMENU_VERSION} - Interactive TUI for Arch Linux package management

Usage: pacmenu [command]

Commands:
  install, i    Install packages (official repos + AUR)
  remove,  r    Remove installed packages
  search,  s    Browse installed packages

Options:
  --help,    -h    Show this help
  --version, -v    Show version

Run without arguments for interactive menu.
EOF
}

show_menu() {
    check_deps
    local choice
    choice=$(printf "install\nremove\nsearch" | fzf \
        --prompt '  pacmenu > ' \
        --header "╭──────────────────────────────────────────────╮
│  pacmenu - Package Manager TUI              │
├──────────────────────────────────────────────┤
│  Select an action:                           │
│    install  - Install packages (repos + AUR) │
│    remove   - Remove installed packages      │
│    search   - Browse installed packages      │
╰──────────────────────────────────────────────╯" \
        --header-first \
        --no-preview \
        --pointer '▶' \
        --border rounded \
        --border-label ' pacmenu ' \
        --border-label-pos 3 \
        --color 'pointer:magenta,prompt:magenta,info:magenta,spinner:magenta,header:magenta' \
        --height '100%' \
        --reverse \
        --margin 0 \
        --padding 1 \
    ) || exit 0

    dispatch "$choice"
}

dispatch() {
    case "${1:-}" in
        install|i)
            exec "$SCRIPT_DIR/pacmenu-install"
            ;;
        remove|r|uninstall|u)
            exec "$SCRIPT_DIR/pacmenu-remove"
            ;;
        search|s|browse|b)
            exec "$SCRIPT_DIR/pacmenu-search"
            ;;
        --help|-h|help)
            show_help
            exit 0
            ;;
        --version|-v|version)
            echo "pacmenu v${PACMENU_VERSION}"
            exit 0
            ;;
        "")
            show_menu
            ;;
        *)
            echo "Unknown command: $1" >&2
            echo "Run 'pacmenu --help' for usage." >&2
            exit 1
            ;;
    esac
}

dispatch "${1:-}"
