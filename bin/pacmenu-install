#!/usr/bin/env bash
# pacmenu-install - Install packages (official repos + AUR)
# Uses fzf for interactive package selection with multi-select

set -euo pipefail

# ── Resolve shared library ───────────────────────────────────────────
SCRIPT_DIR="$(dirname "$(readlink -f "$0")")"
for _lib in \
    "$SCRIPT_DIR/../lib/pacmenu-core.sh" \
    "$HOME/.local/lib/pacmenu/pacmenu-core.sh" \
    "/usr/lib/pacmenu/pacmenu-core.sh"; do
    # shellcheck source=../lib/pacmenu-core.sh
    [[ -f "$_lib" ]] && { source "$_lib"; break; }
done
[[ -z "${PACMENU_VERSION:-}" ]] && { echo "Error: pacmenu-core.sh not found" >&2; exit 1; }

check_deps
detect_pm

# ── Build package list cache ─────────────────────────────────────────
echo -e "${GREEN}${BOLD}Loading package list...${RESET}"

CACHE_DIR="$(get_cache_dir)"
CACHE_FILE="$CACHE_DIR/available-packages"
CACHE_MAX_AGE=3600  # 1 hour

if [[ -f "$CACHE_FILE" ]] && [[ $(($(date +%s) - $(stat -c %Y "$CACHE_FILE"))) -lt $CACHE_MAX_AGE ]]; then
    packages="$CACHE_FILE"
else
    $PM -Slq 2>/dev/null | sort -u > "$CACHE_FILE"
    packages="$CACHE_FILE"
fi

# ── PKGBUILD preview binding ────────────────────────────────────────
if [[ "$PM" == "pacman" ]]; then
    pkgbuild_bind="alt-b:change-preview(echo 'PKGBUILD preview requires an AUR helper (yay or paru)')+change-preview-label( PKGBUILD )"
else
    pkgbuild_bind="alt-b:change-preview($PM -Gpa {1} 2>/dev/null | tail -n +5 || echo 'No PKGBUILD available for {1}')+change-preview-label( PKGBUILD )"
fi

# ── fzf selection ────────────────────────────────────────────────────

HEADER="╭──────────────────────────────────────────────╮
│  Package Installer (official + AUR)          │
├──────────────────────────────────────────────┤
│  Tab: select  Enter: install  Esc: cancel    │
│  Alt-P: toggle preview   Alt-J/K: scroll     │
│  Alt-B: view PKGBUILD    Alt-I: package info  │
╰──────────────────────────────────────────────╯"

selected=$(fzf < "$packages" \
    --multi \
    --prompt '  Install > ' \
    --header "$HEADER" \
    --header-first \
    --preview "$PM -Si {1} 2>/dev/null || echo 'No info available for {1}'" \
    --preview-window 'bottom,65%,wrap,border-top' \
    --preview-label ' Package Info ' \
    --bind 'alt-p:toggle-preview' \
    --bind 'alt-j:preview-down' \
    --bind 'alt-k:preview-up' \
    --bind "$pkgbuild_bind" \
    --bind "alt-i:change-preview($PM -Si {1} 2>/dev/null || echo 'No info available for {1}')+change-preview-label( Package Info )" \
    --color 'pointer:green,marker:green,prompt:green,info:green,spinner:green,header:green' \
    --marker '✓ ' \
    --pointer '▶' \
    --border rounded \
    --border-label ' pacmenu-install ' \
    --border-label-pos 3 \
    --scrollbar '▐' \
    --no-scrollbar \
    --height '100%' \
    --reverse \
    --info inline-right \
    --margin 0 \
    --padding 1 \
) || exit 0

if [[ -z "$selected" ]]; then
    echo "No packages selected."
    exit 0
fi

# Convert selection to array
mapfile -t pkg_array <<< "$selected"
pkg_count=${#pkg_array[@]}

echo ""
echo -e "${GREEN}${BOLD}Installing $pkg_count package(s):${RESET}"
echo -e "${GREEN}  ${pkg_array[*]}${RESET}"
echo ""

# Install (no --noconfirm, user reviews)
if [[ "$PM" == "pacman" ]]; then
    sudo pacman -S --needed "${pkg_array[@]}"
else
    $PM -S --needed "${pkg_array[@]}"
fi
